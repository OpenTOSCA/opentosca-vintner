tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - ../base.yaml
    - cart.service.implementation.yaml

metadata:
    vintner_generate: ansible::gcp, terraform::gcp, ansible::docker, terraform::docker, docker::docker, ansible::kubernetes, terraform::kubernetes, kubernetes::kubernetes

capability_types:
    boutique.capabilities.Endpoint.Cart:
        derived_from: tosca.capabilities.Endpoint

relationship_types:
    boutique.relationships.ConnectsTo.Cart:
        derived_from: tosca.relationships.ConnectsTo

node_types:
    ###################################################
    #
    # Abstract
    #
    ###################################################

    cart.service:
        derived_from: dotnet.application

        properties:
            application_name:
                type: string
                default: cart
                metadata:
                    vintner_ignore: true

            # TODO: make this configurable in DA
            application_port:
                type: string
                default: 7070
                metadata:
                    vintner_name: PORT

            application_protocol:
                type: string
                default: grpc
                metadata:
                    vintner_ignore: true

            application_image:
                type: string
                default: milesstoetzner/boutique-cart:v7
                metadata:
                    vintner_ignore: true

            mysql_host:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::application_endpoint'}

            mysql_port:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::application_port'}

            mysql_database:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::database_name'}

            mysql_user:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::database_user'}

            mysql_password:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::database_password'}

            mysql_table:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::database_table'}

            mysql_ssl_mode:
                type: string
                default: {eval: '.::.requirements::[.name=database]::.target::.requirements::[.name=database]::.target::dbms_ssl_mode'}

            disable_profiler:
                type: string
                default: 1

        capabilities:
            cart:
                type: boutique.capabilities.Endpoint.Cart

        requirements:
            - database:
                  capability: tosca.capabilities.Endpoint.Database
                  relationship: tosca.relationships.ConnectsTo

            - host:
                  capability: tosca.capabilities.Compute
                  relationship: tosca.relationships.HostedOn

    # TODO: cart.service.ansible.gcp
    # TODO: cart.service.terraform.gcp

    # TODO: cart.service.ansible.docker
    # TODO: cart.service.terraform.docker
    # TODO: cart.service.docker.docker

    # TODO: cart.service.ansible.kubernetes
    # TODO: cart.service.terraform.kubernetes
    # TODO. cart.service.kubernetes.kubernetes

    ###################################################
    #
    # Docker Docker
    #
    ###################################################

    cart.service.terraform.gcp:
        derived_from: cart.service

        attributes:
            application_address:
                type: string
                default: {concat: ['localhost', ':', '{{ SELF.application_port }}']}

            application_endpoint:
                type: string
                default: {concat: ['localhost', ':', '{{ SELF.application_port }}']}

        interfaces:
            Standard:
                operations:
                    create: echo 0
                    delete: echo 0
