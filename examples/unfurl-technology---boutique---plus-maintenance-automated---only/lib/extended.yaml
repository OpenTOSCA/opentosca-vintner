tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - base.yaml

node_types:
    ###################################################
    #
    # GCP Provider
    #
    ###################################################

    gcp.provider:
        derived_from: root

        properties:
            env_platform:
                type: string
                default: gcp

            gcp_region:
                type: string

            gcp_service_account_file:
                type: string

            gcp_project:
                type: string

        capabilities:
            host:
                type: tosca.capabilities.Compute

        interfaces:
            Standard:
                operations:
                    create: exit 0
                    delete: exit 0

    ###################################################
    #
    # GCP Service
    #
    ###################################################

    gcp.service:
        derived_from: root
        metadata:
            vintner_generate: 'false'

        properties:
            env_platform:
                type: string
                default: gcp

            gcp_service:
                type: string
                # Unfurl does not accept if there is a default only at the child
                default: 'must-be-overridden'

        capabilities:
            host:
                type: tosca.capabilities.Compute

        requirements:
            - host:
                  capability: tosca.capabilities.Compute
                  relationship: tosca.relationships.HostedOn

    ###################################################
    #
    # Docker Engine
    #
    ###################################################

    docker.engine:
        derived_from: root

        properties:
            env_platform:
                type: string
                default: {eval: '.::.requirements::[.name=host]::.target::env_platform'}

        attributes:
            management_address:
                type: string
                default: {eval: '.::.requirements::[.name=host]::.target::management_address'}

        capabilities:
            host:
                type: tosca.capabilities.Compute
            endpoint:
                type: unfurl.capabilities.Endpoint.Ansible
                properties:
                    connection: ssh
                    host: {eval: '.parent::management_address'}

    ###################################################
    #
    # Kubernetes
    #
    ###################################################

    kubernetes:
        derived_from: root

        properties:
            env_platform:
                type: string
                default: kubernetes

            k8s_host:
                type: string

            k8s_ca_cert_file:
                type: string

            k8s_client_cert_file:
                type: string

            k8s_client_key_file:
                type: string

        capabilities:
            host:
                type: tosca.capabilities.Compute

        interfaces:
            Standard:
                operations:
                    create: exit 0
                    delete: exit 0

    ###################################################
    #
    # Openstack Provider
    #
    ###################################################

    openstack.provider:
        derived_from: root

        properties:
            env_platform:
                type: string
                default: openstack

            os_region_name:
                type: string

            os_auth_type:
                type: string

            os_auth_url:
                type: string

            os_identity_api_version:
                type: string

            os_interface:
                type: string

            os_application_credential_id:
                type: string

            os_application_credential_secret:
                type: string

        capabilities:
            host:
                type: tosca.capabilities.Compute

        interfaces:
            Standard:
                operations:
                    create: exit 0
                    delete: exit 0

    ###################################################
    #
    # Openstack Machine
    #
    ###################################################

    openstack.machine:
        derived_from: compute
        properties:
            env_platform:
                type: string
                default: openstack

            ports:
                type: list
                entry_schema:
                    type: integer

            machine:
                type: string

            flavor:
                type: string
                default: 'm1.medium'

            os_network:
                type: string

        attributes:
            management_address:
                type: string

            application_address:
                type: string
                default: {eval: '.::management_address'}

        capabilities:
            host:
                type: tosca.capabilities.Compute
            endpoint:
                type: unfurl.capabilities.Endpoint.Ansible
                properties:
                    connection: ssh
                    host: {eval: '.parent::management_address'}

    ###################################################
    #
    # MySQL DBMS
    #
    ###################################################

    mysql.dbms:
        derived_from: relational.dbms

        properties:
            dbms_name:
                type: string

            dbms_image:
                type: string
                default: mysql:5.6

            dbms_password:
                type: string

            dbms_ssl_mode:
                type: string
                default: None

        attributes:
            application_address:
                type: string

            application_port:
                type: integer

            management_address:
                type: string

            management_port:
                type: integer

        capabilities:
            host:
                type: tosca.capabilities.Compute

        requirements:
            - host:
                  capability: tosca.capabilities.Compute
                  relationship: tosca.relationships.HostedOn

    ###################################################
    #
    # MySQL Database
    #
    ###################################################

    mysql.database:
        derived_from: relational.database

        properties:
            database_name:
                type: string

            database_user:
                type: string

            database_password:
                type: string

        attributes:
            application_address:
                type: string
                default: {eval: '.::.requirements::[.name=host]::.target::application_address'}

            application_port:
                type: integer
                default: {eval: '.::.requirements::[.name=host]::.target::application_port'}

        capabilities:
            database:
                type: tosca.capabilities.Endpoint.Database

        requirements:
            - host:
                  capability: tosca.capabilities.Compute
                  relationship: tosca.relationships.HostedOn

    # [OPENTOSCA_VINTNER_GENERATION_MARK]

    ################################################################
    #
    # WARNING: Do not edit! This following content is autogenerated!
    #
    ################################################################

    docker.engine::ansible::openstack.machine:
        derived_from: docker.engine
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                ANSIBLE_HOST_KEY_CHECKING: 'False'
                        inputs:
                            playbook:
                                q:
                                    - name: wait for ssh
                                      wait_for_connection:
                                    - name: install docker
                                      ansible.builtin.shell: curl -sSL https://get.docker.com | sh
                                      args:
                                          executable: /usr/bin/bash
                                    - name: add docker group
                                      ansible.builtin.shell: groupadd -f docker
                                      args:
                                          executable: /usr/bin/bash
                                    - name: add user to docker group
                                      ansible.builtin.shell: usermod -aG docker {{ SELF.os_ssh_user }}
                                      args:
                                          executable: /usr/bin/bash
                            playbookArgs:
                                - '--become'
                                - '--key-file={{ SELF.os_ssh_key_file }}'
                                - '--user={{ SELF.os_ssh_user }}'
                    delete: exit 0
    docker.engine::terraform::openstack.machine:
        derived_from: docker.engine
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
            os_ssh_host:
                type: string
                default:
                    eval: .::.requirements::[.name=host]::.target::management_address
        attributes:
            application_address:
                type: string
                default: 127.0.0.1
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        resource:
                            terraform_data:
                                docker:
                                    - connection:
                                          - host: '{{ SELF.os_ssh_host }}'
                                            private_key: ${file("{{ SELF.os_ssh_key_file }}")}
                                            type: ssh
                                            user: '{{ SELF.os_ssh_user }}'
                                      provisioner:
                                          remote-exec:
                                              - inline:
                                                    - curl -sSL https://get.docker.com | sudo sh
                                                    - sudo groupadd -f docker
                                                    - sudo usermod -aG docker {{ SELF.os_ssh_user }}
                    delete: exit 0
    openstack.machine::ansible:
        derived_from: openstack.machine
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_region_name:
                type: string
                default:
                    get_input: os_region_name
            os_auth_type:
                type: string
                default:
                    get_input: os_auth_type
            os_auth_url:
                type: string
                default:
                    get_input: os_auth_url
            os_identity_api_version:
                type: string
                default:
                    get_input: os_identity_api_version
            os_interface:
                type: string
                default:
                    get_input: os_interface
            os_application_credential_id:
                type: string
                default:
                    get_input: os_application_credential_id
            os_application_credential_secret:
                type: string
                default:
                    get_input: os_application_credential_secret
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                            environment:
                                OS_AUTH_TYPE:
                                    eval: .::os_auth_type
                                OS_AUTH_URL:
                                    eval: .::os_auth_url
                                OS_IDENTITY_API_VERSION:
                                    eval: .::os_identity_api_version
                                OS_REGION_NAME:
                                    eval: .::os_region_name
                                OS_INTERFACE:
                                    eval: .::os_interface
                                OS_APPLICATION_CREDENTIAL_ID:
                                    eval: .::os_application_credential_id
                                OS_APPLICATION_CREDENTIAL_SECRET:
                                    eval: .::os_application_credential_secret
                        inputs:
                            playbook:
                                q:
                                    - name: Create security group
                                      openstack.cloud.security_group:
                                          name: '{{ SELF.machine }}'
                                    - name: Open ports
                                      openstack.cloud.security_group_rule:
                                          security_group: '{{ SELF.machine }}'
                                          protocol: tcp
                                          port_range_min: '{{ item }}'
                                          port_range_max: '{{ item }}'
                                          remote_ip_prefix: 0.0.0.0/0
                                          direction: ingress
                                          ethertype: IPv4
                                      loop: '{{ SELF.ports | join("::") | split("::") | map("int") }}'
                                    - name: Create VM
                                      openstack.cloud.server:
                                          state: present
                                          name: '{{ SELF.machine }}'
                                          image: Ubuntu 22.04
                                          key_name: default
                                          flavor: '{{ SELF.flavor }}'
                                          network: '{{ SELF.os_network }}'
                                          security_groups: "{{ 'default,' + SELF.machine }}"
                                          auto_ip: false
                                          timeout: 360
                                      register: server_info
                                    - name: Set attributes
                                      set_fact:
                                          management_address: '{{ server_info.server.accessIPv4 }}'
                            resultTemplate: |
                                - name: SELF
                                  attributes:
                                    management_address: "{{ outputs.management_address | trim }}"
                        outputs:
                            management_address:
                    delete:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                        inputs:
                            playbook:
                                q:
                                    - name: Delete VM
                                      openstack.cloud.server:
                                          state: absent
                                          name: '{{ SELF.machine }}'
                                          delete_fip: true
                                          timeout: 360
                                    - name: Delete security group
                                      openstack.cloud.security_group:
                                          state: absent
                                          name: '{{ SELF.machine }}'
    openstack.machine::terraform:
        derived_from: openstack.machine
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_region_name:
                type: string
                default:
                    get_input: os_region_name
            os_auth_type:
                type: string
                default:
                    get_input: os_auth_type
            os_auth_url:
                type: string
                default:
                    get_input: os_auth_url
            os_identity_api_version:
                type: string
                default:
                    get_input: os_identity_api_version
            os_interface:
                type: string
                default:
                    get_input: os_interface
            os_application_credential_id:
                type: string
                default:
                    get_input: os_application_credential_id
            os_application_credential_secret:
                type: string
                default:
                    get_input: os_application_credential_secret
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                outputs:
                    management_address: management_address
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - openstack:
                                        source: terraform-provider-openstack/openstack
                                        version: ~> 1.48.0
                              required_version: '>= 0.14.0'
                        provider:
                            openstack:
                                - application_credential_id: '{{ SELF.os_application_credential_id }}'
                                  application_credential_secret: '{{ SELF.os_application_credential_secret }}'
                                  auth_url: '{{ SELF.os_auth_url }}'
                                  region: '{{ SELF.os_region_name }}'
                        output:
                            management_address:
                                - value: ${yamldecode(openstack_compute_instance_v2.machine.access_ip_v4)}
                        resource:
                            openstack_compute_instance_v2:
                                machine:
                                    - flavor_name: '{{ SELF.flavor }}'
                                      image_name: Ubuntu 22.04
                                      key_pair: default
                                      name: '{{ SELF.machine }}'
                                      network:
                                          - name: '{{ SELF.os_network }}'
                                      security_groups:
                                          - default
                                          - ${openstack_networking_secgroup_v2.ports.name}
                            openstack_networking_secgroup_rule_v2:
                                port:
                                    - direction: ingress
                                      ethertype: IPv4
                                      for_each: ${toset(split("::", "{{ SELF.ports | join("::") }}"))}
                                      port_range_max: ${each.value}
                                      port_range_min: ${each.value}
                                      protocol: tcp
                                      remote_ip_prefix: 0.0.0.0/0
                                      security_group_id: ${openstack_networking_secgroup_v2.ports.id}
                            openstack_networking_secgroup_v2:
                                ports:
                                    - name: '{{ SELF.machine }}'
    mysql.dbms::ansible::docker.engine:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
        attributes:
            application_address:
                type: string
                default:
                    concat:
                        - localhost
                        - ':'
                        - '{{ SELF.application_port }}'
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                ANSIBLE_HOST_KEY_CHECKING: 'False'
                        inputs:
                            playbook:
                                q:
                                    - name: wait for ssh
                                      wait_for_connection:
                                    - name: start container
                                      community.docker.docker_container:
                                          name: '{{ SELF.dbms_name }}'
                                          image: '{{ SELF.dbms_image }}'
                                          network_mode: host
                                          env:
                                              MYSQL_ROOT_PASSWORD: '{{ SELF.dbms_password | string }}'
                            playbookArgs:
                                - '--become'
                                - '--key-file={{ SELF.os_ssh_key_file }}'
                                - '--user={{ SELF.os_ssh_user }}'
                    delete: exit 0
    mysql.dbms::ansible::kubernetes:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
        attributes:
            application_address:
                type: string
                default:
                    eval: .::dbms_name
            application_port:
                type: integer
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::application_address
            management_port:
                type: integer
                default:
                    eval: .::application_port
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                            environment:
                                K8S_AUTH_HOST:
                                    eval: .::k8s_host
                                K8S_AUTH_SSL_CA_CERT:
                                    eval: .::k8s_ca_cert_file
                                K8S_AUTH_CERT_FILE:
                                    eval: .::k8s_client_cert_file
                                K8S_AUTH_KEY_FILE:
                                    eval: .::k8s_client_key_file
                        inputs:
                            playbook:
                                q:
                                    - name: create deployment
                                      kubernetes.core.k8s:
                                          wait: true
                                          definition:
                                              apiVersion: apps/v1
                                              kind: Deployment
                                              metadata:
                                                  name: '{{ SELF.dbms_name }}'
                                                  namespace: default
                                              spec:
                                                  selector:
                                                      matchLabels:
                                                          app: '{{ SELF.dbms_name }}'
                                                  template:
                                                      metadata:
                                                          labels:
                                                              app: '{{ SELF.dbms_name }}'
                                                      spec:
                                                          containers:
                                                              - image: '{{ SELF.dbms_image }}'
                                                                name: '{{ SELF.dbms_name }}'
                                                                env:
                                                                    - name: MYSQL_ROOT_PASSWORD
                                                                      value: '{{ SELF.dbms_password }}'
                                                                ports:
                                                                    - containerPort: 3306
                                                                      name: mysql
                                    - name: create service
                                      kubernetes.core.k8s:
                                          definition:
                                              apiVersion: v1
                                              kind: Service
                                              metadata:
                                                  name: '{{ SELF.dbms_name }}'
                                                  namespace: default
                                              spec:
                                                  ports:
                                                      - name: mysql
                                                        port: 3306
                                                        targetPort: 3306
                                                  selector:
                                                      app: '{{ SELF.dbms_name }}'
                                                  type: ClusterIP
                    delete: exit 0
    mysql.dbms::ansible::gcp.cloudsql:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            gcp_service_account_file:
                type: string
                default:
                    get_input: gcp_service_account_file
            gcp_region:
                type: string
                default:
                    get_input: gcp_region
            gcp_project:
                type: string
                default:
                    get_input: gcp_project
            dbms_ssl_mode:
                type: string
                default: Preferred
        attributes:
            application_port:
                type: string
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::application_address
            management_port:
                type: integer
                default:
                    eval: .::application_port
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                            environment:
                                GCP_SERVICE_ACCOUNT_FILE:
                                    eval: .::gcp_service_account_file
                                GCP_AUTH_KIND: serviceaccount
                        inputs:
                            playbook:
                                q:
                                    - name: create a instance
                                      register: instance_info
                                      google.cloud.gcp_sql_instance:
                                          name: '{{  SELF.dbms_name }}'
                                          database_version: MYSQL_5_7
                                          settings:
                                              tier: db-f1-micro
                                              availability_type: REGIONAL
                                              backup_configuration:
                                                  binary_log_enabled: true
                                                  enabled: true
                                              ip_configuration:
                                                  authorized_networks:
                                                      - value: 0.0.0.0/0
                                          region: '{{ SELF.gcp_region }}'
                                          project: '{{ SELF.gcp_project }}'
                                    - name: set root password
                                      google.cloud.gcp_sql_user:
                                          name: root
                                          host: '%'
                                          password: '{{ SELF.dbms_password }}'
                                          instance: '{{ instance_info }}'
                                          project: '{{ SELF.gcp_project }}'
                                    - name: aet attributes
                                      set_fact:
                                          application_address: '{{ instance_info.ipAddresses[0].ipAddress | trim }}'
                            resultTemplate: |
                                - name: SELF
                                  attributes:
                                    application_address: "{{ outputs.application_address }}"
                        outputs:
                            application_address:
                    delete:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                        inputs:
                            playbook:
                                q:
                                    - name: Activate service account
                                      shell: gcloud auth activate-service-account --key-file {{ SELF.gcp_service_account_file }} --project {{ SELF.gcp_project }}
                                    - name: Delete Instance
                                      shell: gcloud sql instances delete {{ SELF.dbms_name }} --quiet
    mysql.dbms::terraform::docker.engine:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
            os_ssh_host:
                type: string
                default:
                    eval: .::.requirements::[.name=host]::.target::management_address
        attributes:
            application_address:
                type: string
                default: 127.0.0.1
            application_port:
                type: integer
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::.requirements::[.name=host]::.target::management_address
            management_port:
                type: integer
                default: 3306
        capabilities:
            endpoint:
                type: unfurl.capabilities.Endpoint.Ansible
                properties:
                    connection: ssh
                    host:
                        eval: .parent::management_address
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - docker:
                                        source: kreuzwerker/docker
                                        version: 3.0.2
                        provider:
                            docker:
                                - host: ssh://{{ SELF.os_ssh_user }}@{{ SELF.os_ssh_host }}:22
                                  ssh_opts:
                                      - '-i'
                                      - '{{ SELF.os_ssh_key_file }}'
                                      - '-o'
                                      - IdentitiesOnly=yes
                                      - '-o'
                                      - BatchMode=yes
                                      - '-o'
                                      - UserKnownHostsFile=/dev/null
                                      - '-o'
                                      - StrictHostKeyChecking=no
                        resource:
                            docker_container:
                                application:
                                    - name: '{{ SELF.dbms_name }}'
                                      image: ${docker_image.image.image_id}
                                      network_mode: host
                                      env:
                                          - MYSQL_ROOT_PASSWORD={{ SELF.dbms_password }}
                            docker_image:
                                image:
                                    - name: '{{ SELF.dbms_image }}'
    mysql.dbms::terraform::kubernetes:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
        attributes:
            application_address:
                type: string
                default:
                    eval: .::dbms_name
            application_port:
                type: integer
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::application_address
            management_port:
                type: integer
                default:
                    eval: .::application_port
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - kubernetes:
                                        source: hashicorp/kubernetes
                                        version: 2.31.0
                              required_version: '>= 0.14.0'
                        provider:
                            kubernetes:
                                - client_certificate: ${file("{{ SELF.k8s_client_cert_file }}")}
                                  client_key: ${file("{{ SELF.k8s_client_key_file }}")}
                                  cluster_ca_certificate: ${file("{{ SELF.k8s_ca_cert_file }}")}
                                  host: '{{ SELF.k8s_host }}'
                        resource:
                            kubernetes_deployment_v1:
                                application:
                                    - metadata:
                                          - name: '{{ SELF.dbms_name }}'
                                      spec:
                                          - selector:
                                                - match_labels:
                                                      app: '{{ SELF.dbms_name }}'
                                            template:
                                                - metadata:
                                                      - labels:
                                                            app: '{{ SELF.dbms_name }}'
                                                  spec:
                                                      - container:
                                                            - name: '{{ SELF.dbms_name }}'
                                                              image: '{{ SELF.dbms_image }}'
                                                              env:
                                                                  - name: MYSQL_ROOT_PASSWORD
                                                                    value: '{{ SELF.dbms_password }}'
                                                              port:
                                                                  - container_port: 3306
                                                                    name: mysql
                            kubernetes_service_v1:
                                application:
                                    - metadata:
                                          - name: '{{ SELF.dbms_name }}'
                                      spec:
                                          - port:
                                                - name: mysql
                                                  port: 3306
                                                  target_port: 3306
                                            selector:
                                                app: '{{ SELF.dbms_name }}'
                                            type: ClusterIP
    mysql.dbms::terraform::gcp.cloudsql:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            gcp_service_account_file:
                type: string
                default:
                    get_input: gcp_service_account_file
            gcp_region:
                type: string
                default:
                    get_input: gcp_region
            gcp_project:
                type: string
                default:
                    get_input: gcp_project
            dbms_ssl_mode:
                type: string
                default: Preferred
        attributes:
            application_port:
                type: string
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::application_address
            management_port:
                type: integer
                default:
                    eval: .::application_port
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                outputs:
                    application_address: application_address
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - google:
                                        source: hashicorp/google
                                        version: 4.67.0
                        provider:
                            google:
                                - credentials: '{{ SELF.gcp_service_account_file }}'
                                  project: '{{ SELF.gcp_project }}'
                                  region: '{{ SELF.gcp_region }}'
                        output:
                            application_address:
                                - value: ${google_sql_database_instance.dbms.public_ip_address}
                        resource:
                            google_sql_database_instance:
                                dbms:
                                    - database_version: MYSQL_5_7
                                      deletion_protection: false
                                      name: '{{ SELF.dbms_name }}'
                                      root_password: '{{ SELF.dbms_password }}'
                                      settings:
                                          - availability_type: REGIONAL
                                            backup_configuration:
                                                - binary_log_enabled: true
                                                  enabled: true
                                            ip_configuration:
                                                - authorized_networks:
                                                      - name: public
                                                        value: 0.0.0.0/0
                                                  ipv4_enabled: true
                                            tier: db-f1-micro
                            google_sql_user:
                                user:
                                    - host: '%'
                                      instance: ${google_sql_database_instance.dbms.name}
                                      name: root
                                      password: ${google_sql_database_instance.dbms.root_password}
    mysql.dbms::kubernetes::kubernetes:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
        attributes:
            application_address:
                type: string
                default:
                    eval: .::dbms_name
            application_port:
                type: integer
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::application_address
            management_port:
                type: integer
                default:
                    eval: .::application_port
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                        inputs:
                            playbook:
                                q:
                                    - name: touch manifest
                                      register: manifest
                                      ansible.builtin.tempfile:
                                          suffix: '{{ SELF.dbms_name }}.dbms.manifest.yaml'
                                    - name: create manifest
                                      ansible.builtin.copy:
                                          dest: '{{ manifest.path }}'
                                          content: |
                                              {{ deployment | to_yaml }}
                                              ---
                                              {{ service | to_yaml }}
                                      vars:
                                          deployment:
                                              apiVersion: apps/v1
                                              kind: Deployment
                                              metadata:
                                                  name: '{{ SELF.dbms_name }}'
                                                  namespace: default
                                              spec:
                                                  selector:
                                                      matchLabels:
                                                          app: '{{ SELF.dbms_name }}'
                                                  template:
                                                      metadata:
                                                          labels:
                                                              app: '{{ SELF.dbms_name }}'
                                                      spec:
                                                          containers:
                                                              - image: '{{ SELF.dbms_image }}'
                                                                name: '{{ SELF.dbms_name }}'
                                                                env:
                                                                    - name: MYSQL_ROOT_PASSWORD
                                                                      value: '{{ SELF.dbms_password }}'
                                                                ports:
                                                                    - containerPort: 3306
                                                                      name: mysql
                                          service:
                                              apiVersion: v1
                                              kind: Service
                                              metadata:
                                                  name: '{{ SELF.dbms_name }}'
                                              spec:
                                                  ports:
                                                      - name: mysql
                                                        port: 3306
                                                        targetPort: 3306
                                                  selector:
                                                      app: '{{ SELF.dbms_name }}'
                                                  type: ClusterIP
                                    - name: apply manifest
                                      ansible.builtin.shell: kubectl apply -f {{ manifest.path }}
                                      args:
                                          executable: /usr/bin/bash
                                    - name: wait for deployment
                                      ansible.builtin.shell: kubectl rollout status deployment/{{ SELF.dbms_name }} --timeout 60s
                                      args:
                                          executable: /usr/bin/bash
                                    - name: give DBMS some time
                                      ansible.builtin.pause:
                                          seconds: 10
                    delete: exit 0
    mysql.dbms::docker::docker.engine:
        derived_from: mysql.dbms
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
        attributes:
            application_address:
                type: string
                default: 127.0.0.1
            application_port:
                type: integer
                default: 3306
            management_address:
                type: string
                default:
                    eval: .::.requirements::[.name=host]::.target::management_address
            management_port:
                type: integer
                default: 3306
        capabilities:
            endpoint:
                type: unfurl.capabilities.Endpoint.Ansible
                properties:
                    connection: ssh
                    host:
                        eval: .parent::management_address
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                ANSIBLE_HOST_KEY_CHECKING: 'False'
                        inputs:
                            playbook:
                                q:
                                    - name: wait for ssh
                                      wait_for_connection:
                                    - name: touch compose
                                      register: compose
                                      ansible.builtin.tempfile:
                                          suffix: '{{ SELF.dbms_name }}.compose.yaml'
                                    - name: create compose
                                      ansible.builtin.copy:
                                          dest: '{{ compose.path }}'
                                          content: '{{ manifest | to_yaml }}'
                                      vars:
                                          manifest:
                                              name: '{{ SELF.dbms_name }}'
                                              services:
                                                  application:
                                                      container_name: '{{ SELF.dbms_name }}'
                                                      image: '{{ SELF.dbms_image }}'
                                                      network_mode: host
                                                      environment:
                                                          MYSQL_ROOT_PASSWORD: '{{ SELF.dbms_password }}'
                                    - name: apply compose
                                      ansible.builtin.shell: docker compose -f {{ compose.path }} up -d
                                      args:
                                          executable: /usr/bin/bash
                                    - name: give DBMS some time
                                      ansible.builtin.pause:
                                          seconds: 10
                            playbookArgs:
                                - '--become'
                                - '--key-file={{ SELF.os_ssh_key_file }}'
                                - '--user={{ SELF.os_ssh_user }}'
                    delete: exit 0
    mysql.database::ansible::mysql.dbms::docker.engine:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                ANSIBLE_HOST_KEY_CHECKING: 'False'
                        inputs:
                            playbook:
                                q:
                                    - name: wait for ssh
                                      wait_for_connection:
                                    - name: install pip
                                      apt:
                                          name: python3-pip
                                          state: present
                                    - name: install pymysql
                                      pip:
                                          name: pymysql
                                          state: present
                                    - name: create database
                                      community.mysql.mysql_db:
                                          name: '{{ SELF.database_name }}'
                                          login_host: 127.0.0.1
                                          login_password: '{{ HOST.dbms_password }}'
                                          login_port: 3306
                                          login_user: root
                                    - name: create user (with privileges)
                                      community.mysql.mysql_user:
                                          name: '{{ SELF.database_user }}'
                                          password: '{{ SELF.database_password }}'
                                          host: '%'
                                          priv: '*.*:ALL'
                                          login_host: 127.0.0.1
                                          login_password: '{{ HOST.dbms_password }}'
                                          login_port: 3306
                                          login_user: root
                            playbookArgs:
                                - '--become'
                                - '--key-file={{ SELF.os_ssh_key_file }}'
                                - '--user={{ SELF.os_ssh_user }}'
                    delete: exit 0
    mysql.database::ansible::mysql.dbms::kubernetes:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                        inputs:
                            playbook:
                                q:
                                    - name: create database
                                      ansible.builtin.shell: kubectl exec deploy/{{ HOST.dbms_name }} -- mysql --password={{ HOST.dbms_password }} -e "CREATE DATABASE IF NOT EXISTS {{ SELF.database_name }}";
                                      args:
                                          executable: /usr/bin/bash
                                    - name: create user
                                      ansible.builtin.shell: kubectl exec deploy/{{ HOST.dbms_name }}  -- mysql --password={{ HOST.dbms_password }} -e "CREATE USER IF NOT EXISTS '{{ SELF.database_user }}'@'%' IDENTIFIED BY '{{ SELF.database_password }}'";
                                      args:
                                          executable: /usr/bin/bash
                                    - name: grant privileges
                                      ansible.builtin.shell: kubectl exec deploy/{{ HOST.dbms_name }}  -- mysql --password={{ HOST.dbms_password }} -e "GRANT ALL PRIVILEGES ON *.* TO '{{ SELF.database_user }}'@'%'";
                                      args:
                                          executable: /usr/bin/bash
    mysql.database::ansible::mysql.dbms::gcp.cloudsql:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            gcp_service_account_file:
                type: string
                default:
                    get_input: gcp_service_account_file
            gcp_region:
                type: string
                default:
                    get_input: gcp_region
            gcp_project:
                type: string
                default:
                    get_input: gcp_project
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                            environment:
                                GCP_SERVICE_ACCOUNT_FILE:
                                    eval: .::gcp_service_account_file
                                GCP_AUTH_KIND: serviceaccount
                        inputs:
                            playbook:
                                q:
                                    - name: create a database
                                      google.cloud.gcp_sql_database:
                                          name: '{{ SELF.database_name }}'
                                          charset: utf8
                                          instance: '{{ HOST.dbms_name }}'
                                          project: '{{ SELF.gcp_project }}'
                                    - name: create user (with privileges)
                                      community.mysql.mysql_user:
                                          name: '{{ SELF.database_user }}'
                                          password: '{{ SELF.database_password }}'
                                          host: '%'
                                          priv: '*.*:ALL'
                                          login_host: '{{ HOST.management_address }}'
                                          login_password: '{{ HOST.dbms_password }}'
                                          login_port: 3306
                                          login_user: root
    mysql.database::terraform::mysql.dbms::docker.engine:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
            os_ssh_host:
                type: string
                default:
                    eval: .::.requirements::[.name=host]::.target::management_address
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - mysql:
                                        source: petoju/mysql
                                        version: 3.0.48
                                    ssh:
                                        source: AndrewChubatiuk/ssh
                                        version: 0.2.3
                        data:
                            ssh_tunnel:
                                mysql:
                                    - remote:
                                          port: 3306
                        provider:
                            mysql:
                                - endpoint: ${data.ssh_tunnel.mysql.local.address}
                                  password: '{{ HOST.dbms_password }}'
                                  username: root
                            ssh:
                                - auth:
                                      private_key:
                                          content: ${file(pathexpand("{{ SELF.os_ssh_key_file }}"))}
                                  server:
                                      host: '{{ HOST.management_address }}'
                                      port: 22
                                  user: '{{ SELF.os_ssh_user }}'
                        resource:
                            mysql_database:
                                database:
                                    - name: '{{ SELF.database_name }}'
                            mysql_user:
                                user:
                                    - host: '%'
                                      plaintext_password: '{{ SELF.database_password }}'
                                      user: '{{ SELF.database_user }}'
                            mysql_grant:
                                user:
                                    - database: '{{ SELF.database_name }}'
                                      host: '%'
                                      table: '*'
                                      privileges:
                                          - ALL
                                      user: ${mysql_user.user.user}
    mysql.database::terraform::mysql.dbms::kubernetes:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
    mysql.database::terraform::mysql.dbms::gcp.cloudsql:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            gcp_service_account_file:
                type: string
                default:
                    get_input: gcp_service_account_file
            gcp_region:
                type: string
                default:
                    get_input: gcp_region
            gcp_project:
                type: string
                default:
                    get_input: gcp_project
        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
                    delete:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - google:
                                        source: hashicorp/google
                                        version: 5.39.1
                                    mysql:
                                        source: petoju/mysql
                                        version: 3.0.48
                        provider:
                            google:
                                - credentials: '{{ SELF.gcp_service_account_file }}'
                                  project: '{{ SELF.gcp_project }}'
                                  region: '{{ SELF.gcp_region }}'
                            mysql:
                                - endpoint: '{{ HOST.management_address }}'
                                  password: '{{ HOST.dbms_password }}'
                                  username: root
                        resource:
                            google_sql_database:
                                database:
                                    - name: '{{ SELF.database_name }}'
                                      instance: '{{ HOST.dbms_name }}'
                            google_sql_user:
                                user:
                                    - host: '%'
                                      instance: '{{ HOST.dbms_name }}'
                                      name: '{{ SELF.database_name }}'
                                      password: '{{ SELF.database_password }}'
                            mysql_grant:
                                user:
                                    - database: '{{ SELF.database_name }}'
                                      host: '%'
                                      table: '*'
                                      privileges:
                                          - ALL
                                      user: ${google_sql_user.user.name}
    mysql.database::kubernetes::mysql.dbms::kubernetes:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            k8s_host:
                type: string
                default:
                    get_input: k8s_host
            k8s_ca_cert_file:
                type: string
                default:
                    get_input: k8s_ca_cert_file
            k8s_client_cert_file:
                type: string
                default:
                    get_input: k8s_client_cert_file
            k8s_client_key_file:
                type: string
                default:
                    get_input: k8s_client_key_file
        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: ORCHESTRATOR
                        inputs:
                            playbook:
                                q:
                                    - name: touch manifest
                                      register: manifest
                                      ansible.builtin.tempfile:
                                          suffix: '{{ SELF.database_name }}-{{ HOST.dbms_name }}.database.manifest.yaml'
                                    - name: create manifest
                                      ansible.builtin.copy:
                                          dest: '{{ manifest.path }}'
                                          content: '{{ job | to_yaml }}'
                                      vars:
                                          job:
                                              apiVersion: batch/v1
                                              kind: Job
                                              metadata:
                                                  name: '{{ SELF.database_name }}-{{ HOST.dbms_name }}'
                                              spec:
                                                  template:
                                                      spec:
                                                          restartPolicy: Never
                                                          initContainers:
                                                              - name: create-database
                                                                image: '{{ HOST.dbms_image }}'
                                                                command:
                                                                    - mysql
                                                                    - '--host={{ HOST.management_address }}'
                                                                    - '--port={{ HOST.management_port }}'
                                                                    - '--user=root'
                                                                    - '--password={{ HOST.dbms_password }}'
                                                                    - '-e'
                                                                    - CREATE DATABASE IF NOT EXISTS {{ SELF.database_name }}
                                                              - name: create-user
                                                                image: '{{ HOST.dbms_image }}'
                                                                command:
                                                                    - mysql
                                                                    - '--host={{ HOST.management_address }}'
                                                                    - '--port={{ HOST.management_port }}'
                                                                    - '--user=root'
                                                                    - '--password={{ HOST.dbms_password }}'
                                                                    - '-e'
                                                                    - CREATE USER IF NOT EXISTS '{{ SELF.database_user }}'@'%' IDENTIFIED BY '{{ SELF.database_password }}'
                                                              - name: grant-privileges
                                                                image: '{{ HOST.dbms_image }}'
                                                                command:
                                                                    - mysql
                                                                    - '--host={{ HOST.management_address }}'
                                                                    - '--port={{ HOST.management_port }}'
                                                                    - '--user=root'
                                                                    - '--password={{ HOST.dbms_password }}'
                                                                    - '-e'
                                                                    - GRANT ALL PRIVILEGES ON *.* TO '{{ SELF.database_user }}'@'%'
                                                          containers:
                                                              - name: none
                                                                image: busybox
                                                                command:
                                                                    - echo
                                                                    - "'done'"
                                    - name: apply manifest
                                      ansible.builtin.shell: kubectl apply -f {{ manifest.path }}
                                      args:
                                          executable: /usr/bin/bash
                                    - name: wait for deployment
                                      ansible.builtin.shell: kubectl wait --for=condition=complete --timeout=30s job/{{ SELF.database_name }}-{{ HOST.dbms_name }}
                                      args:
                                          executable: /usr/bin/bash
                                    - name: cleanup
                                      ansible.builtin.shell: kubectl delete -f {{ manifest.path }}
                                      args:
                                          executable: /usr/bin/bash
                    delete: exit 0
    mysql.database::docker::mysql.dbms::docker.engine:
        derived_from: mysql.database
        metadata:
            vintner_generated: 'true'
            vintner_orchestrator: unfurl
        properties:
            os_ssh_user:
                type: string
                default:
                    get_input: os_ssh_user
            os_ssh_key_file:
                type: string
                default:
                    get_input: os_ssh_key_file
