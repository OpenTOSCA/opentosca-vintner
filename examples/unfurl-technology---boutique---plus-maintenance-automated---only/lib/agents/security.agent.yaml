tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - ../base.yaml

node_types:
    ###################################################
    #
    # Abstract
    #
    ###################################################

    falco.agent:
        derived_from: security.agent
        requirements:
            - host:
                  capability: tosca.capabilities.Compute
                  relationship: tosca.relationships.HostedOn

    ###################################################
    #
    # Ansible Openstack
    #
    ###################################################

    falco.agent::ansible::openstack.machine:
        derived_from: falco.agent

        properties:
            os_ssh_user:
                type: string
                default: {get_input: os_ssh_user}

            os_ssh_key_file:
                type: string
                default: {get_input: os_ssh_key_file}

        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                ANSIBLE_HOST_KEY_CHECKING: 'False'
                        inputs:
                            playbook:
                                q:
                                    - name: wait for ssh
                                      wait_for_connection:

                                    # https://falco.org/docs/install-operate/installation
                                    # https://falco.org/docs/getting-started/falco-linux-quickstart
                                    - name: install Falco
                                      ansible.builtin.shell: |
                                          mkdir -p /etc/apt/keyrings/
                                          curl -fsSL https://falco.org/repo/falcosecurity-packages.asc | sudo gpg --dearmor -o /usr/share/keyrings/falco-archive-keyring.gpg
                                          echo "deb [signed-by=/usr/share/keyrings/falco-archive-keyring.gpg] https://download.falco.org/packages/deb stable main" | tee /etc/apt/sources.list.d/falcosecurity.list

                                          apt-get update
                                          apt-get install -y dkms make linux-headers-$(uname -r) dialog
                                          FALCO_FRONTEND=noninteractive  apt-get install -y falco
                                      args:
                                          executable: /usr/bin/bash

                            playbookArgs:
                                - --become
                                - --key-file={{ SELF.os_ssh_key_file }}
                                - --user={{ SELF.os_ssh_user }}
                    delete: exit 0

    ###################################################
    #
    # Terraform Openstack
    #
    ###################################################

    falco.agent::terraform::openstack.machine:
        derived_from: falco.agent

        properties:
            os_ssh_user:
                type: string
                default: {get_input: os_ssh_user}

            os_ssh_key_file:
                type: string
                default: {get_input: os_ssh_key_file}

            os_ssh_host:
                type: string
                default: {eval: '.::.requirements::[.name=host]::.target::management_address'}

        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        resource:
                            terraform_data:
                                os:
                                    - connection:
                                          - host: '{{ SELF.os_ssh_host }}'
                                            private_key: ${file("{{ SELF.os_ssh_key_file }}")}
                                            type: ssh
                                            user: '{{ SELF.os_ssh_user }}'
                                      provisioner:
                                          file:
                                              - content: |
                                                    mkdir -p /etc/apt/keyrings/
                                                    curl -fsSL https://falco.org/repo/falcosecurity-packages.asc | sudo gpg --dearmor -o /usr/share/keyrings/falco-archive-keyring.gpg
                                                    echo "deb [signed-by=/usr/share/keyrings/falco-archive-keyring.gpg] https://download.falco.org/packages/deb stable main" | tee /etc/apt/sources.list.d/falcosecurity.list

                                                    apt-get update
                                                    apt-get install -y dkms make linux-headers-$(uname -r) dialog
                                                    FALCO_FRONTEND=noninteractive apt-get install -y falco
                                                destination: /tmp/install-security-agent.sh
                                          remote-exec:
                                              - inline:
                                                    - sudo bash /tmp/install-security-agent.sh
