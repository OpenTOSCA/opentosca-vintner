# https://github.com/GoogleCloudPlatform/microservices-demo

tosca_definitions_version: tosca_variability_1_0_rc_3

imports:
    - lib/types.yaml

topology_template:
    inputs:
        database_password:
            type: string

        dbms_password:
            type: string

        os_network:
            type: string

        os_ssh_key_name:
            type: string

        os_ssh_user:
            type: string

        os_ssh_key_file:
            type: string

        os_region_name:
            type: string

        os_auth_type:
            type: string

        os_auth_url:
            type: string

        os_identity_api_version:
            type: string

        os_interface:
            type: string

        os_application_credential_id:
            type: string

        os_application_credential_secret:
            type: string

        gcp_region:
            type: string

        gcp_service_account_file:
            type: string

        gcp_project:
            type: string

        k8s_api_address:
            type: string

        k8s_api_port:
            type: string

        k8s_ca_cert_file:
            type: string

        k8s_client_cert_file:
            type: string

        k8s_client_key_file:
            type: string

    variability:
        expressions:
            is_gcp: {equal: [{variability_input: env}, GCP]}
            is_kubernetes: {equal: [{variability_input: env}, KUBERNETES]}
            is_openstack: {equal: [{variability_input: env}, OPENSTACK]}
            has_optional_feature: {equal: [{variability_input: optional_feature}, true]}
            has_premium_feature: {equal: [{variability_input: premium_feature}, true]}
        inputs:
            env:
                type: string
                default: DOCKER

            tier:
                type: string
                default: MEDIUM

            optional_feature:
                type: boolean
                default: false

            premium_feature:
                type: boolean
                default: false
        options:
            # TODO: remove this
            required_technology_check: false

    node_templates:
        ###################################################
        #
        # Frontend
        #
        ###################################################

        frontend_service:
            type: frontend.service
            persistent: true
            properties:
                - checkout_address: {eval: '.::.requirements[.name=checkout]::.target::application_address'}
                - currency_address: {eval: '.::.requirements[.name=currency]::.target::application_address'}
                - shipping_address: {eval: '.::.requirements[.name=shipping]::.target::application_address'}
                - cart_address: {eval: '.::.requirements[.name=cart]::.target::application_address'}
                - product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
                - recommendation_address: {eval: '.::.requirements[.name=recommendation]::.target::application_address'}
                - advertisement_address: {eval: '.::.requirements[.name=advertisement]::.target::application_address'}
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - checkout: checkout_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - recommendation: recommendation_service
                - advertisement: advertisement_service
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/frontend:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: frontend-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        frontend_ingress:
            type: ingress
            technology:
                - ansible:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
            properties:
                - upstream_address: {eval: '.::.requirements[.name=checkout]::.target::application_address'}
            requirements:
                - upstream: frontend_service

                - host: kubernetes_runtime
                - host: virtual_machine

        ###################################################
        #
        # Checkout
        #
        ###################################################

        checkout_service:
            type: checkout.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            properties:
                - email_address: {eval: '.::.requirements[.name=email]::.target::application_address'}
                - payment_address: {eval: '.::.requirements[.name=payment]::.target::application_address'}
                - currency_address: {eval: '.::.requirements[.name=currency]::.target::application_address'}
                - shipping_address: {eval: '.::.requirements[.name=shipping]::.target::application_address'}
                - cart_address: {eval: '.::.requirements[.name=cart]::.target::application_address'}
                - product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
            requirements:
                - email: email_service
                - payment: payment_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/checkoutservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: checkoutservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Email
        #
        ###################################################

        email_service:
            type: email.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/emailservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: emailservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Payment
        #
        ###################################################

        payment_service:
            type: payment.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            properties:
                - optional_feature:
                      value: true
                      conditions: {logic_expression: has_optional_feature}
                - optional_feature:
                      value: false
                      conditions: {not: {logic_expression: has_optional_feature}}
                - premium_feature:
                      value: true
                      conditions: {logic_expression: has_premium_feature}
                - premium_feature:
                      value: false
                      conditions: {not: {logic_expression: has_premium_feature}}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/paymentservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: paymentservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Currency
        #
        ###################################################

        currency_service:
            type: currency.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/currencyservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: currencyservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Shipping
        #
        ###################################################

        shipping_service:
            type: shipping.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/shippingservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: shippingservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Cart
        #
        ###################################################

        cart_service:
            type: cart.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            properties:
                - database_name: cart
                - database_user: cart
                - database_password: {get_input: database_password}
            requirements:
                - database: postgresql_database
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/cartservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: cartservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        postgresql_database:
            type: postgresql.database
            technology: terraform
            properties:
                - database_name: cart
                - database_user: cart
                - database_password: {get_input: database_password}
            requirements:
                - host: postgresql_dbms

        postgresql_dbms:
            type: postgresql.dbms
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            properties:
                - dbms_name: cart
                - dbms_password: {get_input: dbms_password}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_cloudsql

        ###################################################
        #
        # Product
        #
        ###################################################

        product_service:
            type: product.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/productservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: productservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Recommendation
        #
        ###################################################

        recommendation_service:
            type: recommendation.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            properties:
                - product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
            requirements:
                - product: product_service
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/recommendationervice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: recommendationservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Advertisement
        #
        ###################################################

        advertisement_service:
            type: advertisement.service
            technology:
                - docker:
                      conditions: {logic_expression: is_openstack}
                - kubernetes:
                      conditions: {logic_expression: is_kubernetes}
                - terraform:
                      conditions: {logic_expression: is_gcp}
            requirements:
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine
            artifacts:
                - docker:
                      file: gcr.io/google-samples/microservices-demo/advertisementservice:v0.10.1
                      conditions: {or: [{node_presence: docker_runtime}, {node_presence: kubernetes_runtime}]}
                - archive:
                      file: advertisementservice-v0.10.1.tar.gz
                      conditions: {node_presence: gcp_appengine}

        ###################################################
        #
        # Virtual Machine
        #
        ###################################################

        docker_runtime:
            type: docker.engine
            technology: ansible
            requirements:
                - host: virtual_machine

        monitoring_agent:
            type: monitoring.agent
            technology: ansible
            requirements:
                - host: virtual_machine

        logging_agent:
            type: logging.agent
            technology: ansible
            requirements:
                - host: virtual_machine

        security_agent:
            type: security.agent
            technology: ansible
            requirements:
                - host: virtual_machine

        virtual_machine:
            type: openstack.machine
            technology: terraform
            properties:
                - machine: unfurl-technology-gcp
                - ports: [80, 3000, 8000]
                - flavor:
                      value: m1.medium
                      conditions: {equal: [{variability_input: tier}, MEDIUM]}
                - flavor:
                      value: m1.large
                      conditions: {equal: [{variability_input: tier}, LARGE]}

                - os_network: {get_input: os_network}
                - os_ssh_key_name: {get_input: os_ssh_key_name}
                - os_ssh_user: {get_input: os_ssh_user}
                - os_ssh_key_file: {get_input: os_ssh_key_file}
                - os_region_name: {get_input: os_region_name}

            requirements:
                - host: openstack

        openstack:
            type: openstack.provider
            conditions: {logic_expression: is_openstack}
            properties:
                - os_region_name: {get_input: os_region_name}
                - os_auth_type: {get_input: os_auth_type}
                - os_auth_url: {get_input: os_auth_url}
                - os_identity_api_version: {get_input: os_identity_api_version}
                - os_interface: {get_input: os_interface}
                - os_application_credential_id: {get_input: os_application_credential_id}
                - os_application_credential_secret: {get_input: os_application_credential_secret}

        ###################################################
        #
        # GCP
        #
        ###################################################

        gcp_appengine:
            type: gcp.appengine
            technology: terraform
            requirements:
                - host: gcp_provider

        gcp_cloudsql:
            type: gcp.cloudsql
            technology: terraform
            requirements:
                - host: gcp_provider

        gcp_provider:
            type: gcp.provider
            conditions: {logic_expression: is_gcp}
            properties:
                - gcp_region: {get_input: gcp_region}
                - gcp_service_account_file: {get_input: gcp_service_account_file}
                - gcp_project: {get_input: gcp_project}

        ###################################################
        #
        # Kubernetes
        #
        ###################################################

        kubernetes_runtime:
            type: kubernetes
            conditions: {logic_expression: is_kubernetes}
            properties:
                - k8s_api_address: {get_input: k8s_api_address}
                - k8s_api_port: {get_input: k8s_api_port}
                - k8s_ca_cert_file: {get_input: k8s_ca_cert_file}
                - k8s_client_cert_file: {get_input: k8s_client_cert_file}
                - k8s_client_key_file: {get_input: k8s_client_key_file}
