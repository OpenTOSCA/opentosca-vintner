tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - ../base.yaml
    - gcp.service.yaml

node_types:
    ###################################################
    #
    # Abstract
    #
    ###################################################

    gcp.cloudsql:
        derived_from: gcp.service

        properties:
            gcp_service_account_file:
                type: string
                default: {get_input: gcp_service_account_file}

            gcp_region:
                type: string
                default: {get_input: gcp_region}

            gcp_project:
                type: string
                default: {get_input: gcp_project}

            gcp_service:
                type: string
                default: 'sqladmin.googleapis.com'

    ###################################################
    #
    # Ansible GCP
    #
    ###################################################

    # TODO: test this

    gcp.cloudsql.ansible.gcp:
        derived_from: gcp.service

        interfaces:
            Standard:
                operations:
                    create:
                        implementation:
                            primary: Ansible
                            operation_host: HOST
                            environment:
                                GCP_SERVICE_ACCOUNT_FILE: '{{ SELF.gcp_service_account_file }}'
                                GCP_AUTH_KIND: 'serviceaccount'
                        inputs:
                            playbook:
                                q:
                                    - name: enable service
                                      google.cloud.gcp_serviceusage_service:
                                          name: '{{ SELF.gcp_service }}'
                    delete: exit 0

    ###################################################
    #
    # Terraform GCP
    #
    ###################################################

    # TODO: test this

    gcp.cloudsql.terraform.gcp:
        derived_from: gcp.service

        interfaces:
            Standard:
                operations:
                    configure:
                        implementation:
                            primary: Terraform
            defaults:
                inputs:
                    main:
                        terraform:
                            - required_providers:
                                  - google:
                                        source: hashicorp/google
                                        version: 4.67.0
                        provider:
                            google:
                                - credentials: '{{ SELF.gcp_service_account_file }}'
                                  project: '{{ SELF.gcp_project }}'
                                  region: '{{ SELF.gcp_region }}'
                        resource:
                            google_project_service:
                                cloud_sql_admin:
                                    - disable_on_destroy: false
                                      project: '{{ SELF.gcp_project }}'
                                      service: '{{ SELF.gcp_service }}'
