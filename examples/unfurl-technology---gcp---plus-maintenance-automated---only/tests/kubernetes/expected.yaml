tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - lib/types.yaml

topology_template:
    inputs:
        database_password:
            type: string

        dbms_password:
            type: string

        k8s_api_address:
            type: string

        k8s_api_port:
            type: string

        k8s_ca_cert_file:
            type: string

        k8s_client_cert_file:
            type: string

        k8s_client_key_file:
            type: string

    node_templates:
        ###################################################
        #
        # Frontend
        #
        ###################################################

        frontend_service:
            type: frontend.service.kubernetes.kubernetes
            properties:
                checkout_address: {eval: '.::.requirements[.name=checkout]::.target::application_address'}
                currency_address: {eval: '.::.requirements[.name=currency]::.target::application_address'}
                shipping_address: {eval: '.::.requirements[.name=shipping]::.target::application_address'}
                cart_address: {eval: '.::.requirements[.name=cart]::.target::application_address'}
                product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
                recommendation_address: {eval: '.::.requirements[.name=recommendation]::.target::application_address'}
                advertisement_address: {eval: '.::.requirements[.name=advertisement]::.target::application_address'}
            requirements:
                - checkout: checkout_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - recommendation: recommendation_service
                - advertisement: advertisement_service
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/frontend:v0.10.1

        frontend_ingress:
            type: ingress.kubernetes.kubernetes
            properties:
                upstream_address: {eval: '.::.requirements[.name=checkout]::.target::application_address'}
            requirements:
                - upstream: frontend_service
                - host: kubernetes_runtime

        ###################################################
        #
        # Checkout
        #
        ###################################################

        checkout_service:
            type: checkout.service.kubernetes.kubernetes
            properties:
                email_address: {eval: '.::.requirements[.name=email]::.target::application_address'}
                payment_address: {eval: '.::.requirements[.name=payment]::.target::application_address'}
                currency_address: {eval: '.::.requirements[.name=currency]::.target::application_address'}
                shipping_address: {eval: '.::.requirements[.name=shipping]::.target::application_address'}
                cart_address: {eval: '.::.requirements[.name=cart]::.target::application_address'}
                product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
            requirements:
                - email: email_service
                - payment: payment_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/checkoutservice:v0.10.1

        ###################################################
        #
        # Email
        #
        ###################################################

        email_service:
            type: email.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/emailservice:v0.10.1

        ###################################################
        #
        # Payment
        #
        ###################################################

        payment_service:
            type: payment.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/paymentservice:v0.10.1

        ###################################################
        #
        # Currency
        #
        ###################################################

        currency_service:
            type: currency.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/currencyservice:v0.10.1

        ###################################################
        #
        # Shipping
        #
        ###################################################

        shipping_service:
            type: shipping.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/shippingservice:v0.10.1

        ###################################################
        #
        # Cart
        #
        ###################################################

        cart_service:
            type: cart.service.kubernetes.kubernetes
            properties:
                database_name: cart
                database_user: cart
                database_password: {get_input: database_password}
            requirements:
                - database: postgresql_database
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/cartservice:v0.10.1

        postgresql_database:
            type: postgresql.database.terraform.postgresql
            properties:
                database_name: cart
                database_user: cart
                database_password: {get_input: database_password}
            requirements:
                - host: postgresql_dbms

        postgresql_dbms:
            type: postgresql.dbms.kubernetes.kubernetes
            properties:
                dbms_name: cart
                dbms_password: {get_input: dbms_password}
            requirements:
                - host: kubernetes_runtime

        ###################################################
        #
        # Product
        #
        ###################################################

        product_service:
            type: product.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/productservice:v0.10.1

        ###################################################
        #
        # Recommendation
        #
        ###################################################

        recommendation_service:
            type: recommendation.service.kubernetes.kubernetes
            properties:
                product_address: {eval: '.::.requirements[.name=product]::.target::application_address'}
            requirements:
                - product: product_service
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/recommendationervice:v0.10.1

        ###################################################
        #
        # Advertisement
        #
        ###################################################

        advertisement_service:
            type: advertisement.service.kubernetes.kubernetes
            requirements:
                - host: kubernetes_runtime
            artifacts:
                docker:
                    file: gcr.io/google-samples/microservices-demo/advertisementservice:v0.10.1

        ###################################################
        #
        # Kubernetes
        #
        ###################################################

        kubernetes_runtime:
            type: kubernetes
            properties:
                k8s_api_address: {get_input: k8s_api_address}
                k8s_api_port: {get_input: k8s_api_port}
                k8s_ca_cert_file: {get_input: k8s_ca_cert_file}
                k8s_client_cert_file: {get_input: k8s_client_cert_file}
                k8s_client_key_file: {get_input: k8s_client_key_file}
