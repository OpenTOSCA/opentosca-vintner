tosca_definitions_version: tosca_simple_yaml_1_3

imports:
    - lib/types.yaml

topology_template:
    inputs:
        database_password:
            type: string

        dbms_password:
            type: string

        gcp_region:
            type: string

        gcp_service_account_file:
            type: string

        gcp_project:
            type: string

    node_templates:
        ###################################################
        #
        # Frontend
        #
        ###################################################

        frontend_service:
            type: frontend.service.terraform.gcp
            properties:
                optional_payment_feature: {get_property: [payment_service, optional_payment_feature]}
                premium_payment_feature: {get_property: [payment_service, premium_payment_feature]}
            requirements:
                - checkout: checkout_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - recommendation: recommendation_service
                - advertisement: advertisement_service
                - host: gcp_appengine

        ###################################################
        #
        # Checkout
        #
        ###################################################

        checkout_service:
            type: checkout.service.terraform.gcp
            properties:
                optional_payment_feature: {get_property: [payment_service, optional_payment_feature]}
                premium_payment_feature: {get_property: [payment_service, premium_payment_feature]}
            requirements:
                - email: email_service
                - payment: payment_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - host: gcp_appengine

        ###################################################
        #
        # Email
        #
        ###################################################

        email_service:
            type: email.service.terraform.gcp
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # Payment
        #
        ###################################################

        payment_service:
            type: payment.service.terraform.gcp
            properties:
                optional_feature: false
                premium_feature: false
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # Currency
        #
        ###################################################

        currency_service:
            type: currency.service.terraform.gcp
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # Shipping
        #
        ###################################################

        shipping_service:
            type: shipping.service.terraform.gcp
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # Cart
        #
        ###################################################

        cart_service:
            type: cart.service.terraform.gcp
            requirements:
                - database: mysql_database
                - host: gcp_appengine

        mysql_database:
            type: mysql.database.terraform.mysql
            properties:
                database_name: cart
                database_user: cart
                database_password: {get_input: database_password}
            requirements:
                - host: mysql_dbms

        mysql_dbms:
            type: mysql.dbms.terraform.gcp
            properties:
                dbms_name: cart
                dbms_password: {get_input: dbms_password}
            requirements:
                - host: gcp_cloudsql

        ###################################################
        #
        # Product
        #
        ###################################################

        product_service:
            type: product.service.terraform.gcp
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # Recommendation
        #
        ###################################################

        recommendation_service:
            type: recommendation.service.terraform.gcp
            requirements:
                - product: product_service
                - host: gcp_appengine

        ###################################################
        #
        # Advertisement
        #
        ###################################################

        advertisement_service:
            type: advertisement.service.terraform.gcp
            requirements:
                - host: gcp_appengine

        ###################################################
        #
        # GCP
        #
        ###################################################

        gcp_appengine:
            type: gcp.appengine.terraform.gcp
            requirements:
                - host: gcp_provider

        gcp_cloudsql:
            type: gcp.cloudsql.terraform.gcp
            requirements:
                - host: gcp_provider

        gcp_provider:
            type: gcp.provider
            properties:
                gcp_region: {get_input: gcp_region}
                gcp_service_account_file: {get_input: gcp_service_account_file}
                gcp_project: {get_input: gcp_project}
