# https://github.com/GoogleCloudPlatform/microservices-demo

tosca_definitions_version: tosca_variability_1_0_rc_3

imports:
    - lib/types.yaml

topology_template:
    variability:
        expressions:
            is_docker: {equal: [{variability_input: env}, DOCKER]}
            is_gcp: {equal: [{variability_input: env}, GCP]}
            is_kubernetes: {equal: [{variability_input: env}, KUBERNETES]}
            is_openstack: {equal: [{variability_input: env}, OPENSTACK]}
        inputs:
            env:
                type: string
                default: DOCKER

            tier:
                type: string
                default: MEDIUM

        options:
            # TODO: remove this
            required_technology_check: false
            # TODO: must be "true" to work
            optimization_technologies: true

    node_templates:
        ###################################################
        #
        # Frontend
        #
        ###################################################

        frontend_service:
            type: frontend.service
            persistent: true
            requirements:
                - checkout: checkout_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service
                - recommendation: recommendation_service
                - advertisement: advertisement_service

                - host: go_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Checkout
        #
        ###################################################

        checkout_service:
            type: checkout.service
            requirements:
                - email: email_service
                - payment: payment_service
                - currency: currency_service
                - shipping: shipping_service
                - cart: cart_service
                - product: product_service

                - host: go_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Email
        #
        ###################################################

        email_service:
            type: email.service
            requirements:
                - host: python_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Payment
        #
        ###################################################

        payment_service:
            type: payment.service
            requirements:
                - host: node_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Currency
        #
        ###################################################

        currency_service:
            type: currency.service
            requirements:
                - host: node_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Shipping
        #
        ###################################################

        shipping_service:
            type: shipping.service
            requirements:
                - host: go_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Cart
        #
        ###################################################

        cart_service:
            type: cart.service
            requirements:
                - database: postgresql_database

                - host: csharp_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        postgresql_database:
            type: postgresql.database
            requirements:
                - host: postgresql_dbms

        postgresql_dbms:
            type: postgresql.dbms
            requirements:
                - host: virtual_machine
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_cloudsql

        ###################################################
        #
        # Product
        #
        ###################################################

        product_service:
            type: product.service
            requirements:
                - host: go_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Recommendation
        #
        ###################################################

        recommendation_service:
            type: recommendation.service
            requirements:
                - product: product_service

                - host: python_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Advertisement
        #
        ###################################################

        advertisement_service:
            type: advertisement.service
            requirements:
                - host: java_runtime
                - host: docker_runtime
                - host: kubernetes_runtime
                - host: gcp_appengine

        ###################################################
        #
        # Virtual Machine
        #
        ###################################################

        go_runtime:
            type: go.runtime
            requirements:
                - host: virtual_machine

        csharp_runtime:
            type: csharp.runtime
            requirements:
                - host: virtual_machine

        node_runtime:
            type: node.runtime
            requirements:
                - host: virtual_machine

        python_runtime:
            type: python.runtime
            requirements:
                - host: virtual_machine

        java_runtime:
            type: java.runtime
            requirements:
                - host: virtual_machine

        virtual_machine:
            type: openstack.machine
            properties:
                - flavor:
                      value: m1.medium
                      conditions: {equal: [{variability_input: tier}, MEDIUM]}
                - flavor:
                      value: m1.large
                      conditions: {equal: [{variability_input: tier}, LARGE]}

            requirements:
                - host: openstack

        openstack:
            type: openstack.provider
            conditions: {logic_expression: is_openstack}

        ###################################################
        #
        # Docker
        #
        ###################################################

        docker_runtime:
            type: docker.engine
            conditions: {logic_expression: is_docker}

        ###################################################
        #
        # GCP
        #
        ###################################################

        gcp_appengine:
            type: gcp.appengine
            requirements:
                - host: gcp_provider

        gcp_cloudsql:
            type: gcp.cloudsql
            requirements:
                - host: gcp_provider

        gcp_provider:
            type: gcp.provider
            conditions: {logic_expression: is_gcp}

        ###################################################
        #
        # Kubernetes
        #
        ###################################################

        kubernetes_runtime:
            type: kubernetes
            conditions: {logic_expression: is_kubernetes}
