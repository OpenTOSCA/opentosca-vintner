tosca_definitions_version: tosca_simple_yaml_1_3

node_types:
  node_exporter:
    derived_from: tosca.nodes.SoftwareComponent
    interfaces:
      Standard:
        create:
          implementation:
            primary: Ansible
            operation_host: HOST
          inputs:
            playbook:
              q:
              - name: wait for ssh
                wait_for_connection:
                  delay: 10
                  sleep: 5
                  timeout: 300

              - name: check if node exporter exist
                stat:
                  path: /usr/local/bin/node_exporter
                register: node_exporter_stat

              - name: create node exporter config dir
                file:
                  path: /etc/node_exporter
                  state: directory
                
              - name: download and unzip node exporter if not exist
                unarchive:
                  src: https://github.com/prometheus/node_exporter/releases/download/v1.6.0/node_exporter-1.6.0.linux-amd64.tar.gz
                  dest: /tmp/
                  remote_src: yes
                when: node_exporter_stat.stat.exists == false
          
              - name: move the binary to the final destination
                copy:
                  src: /tmp/node_exporter-1.6.0.linux-amd64/node_exporter
                  dest: /usr/local/bin/node_exporter
                  owner: node-exporter
                  remote_src: yes
                when: node_exporter_stat.stat.exists == false

              - name: cleanup
                file:
                  path: /tmp/node_exporter-1.6.0.linux-amd64/
                  state: absent

              - name: create service
                copy:
                  dest: /etc/systemd/system/node_exporter.service
                  contnet: | 
                    [Unit]
                    Description=Node Exporter
                    After=network.target
                    
                    [Service]
                    Type=simple
                    ExecStart=/usr/local/bin/node_exporter
                    
                    [Install]
                    WantedBy=multi-user.target

              - name: start service
                systemd:
                  name: node_exporter
                  state: started
                  enabled: yes
                  daemon_reload: yes

            playbookArgs:
            - "--become"

            environment:
              ANSIBLE_SSH_PRIVATE_KEY_FILE: {get_input: ssh_key_file}
              ANSIBLE_SSH_USER: {get_input: ssh_user}
              ANSIBLE_SSH_COMMON_ARGS: >
                -o IdentitiesOnly=yes
                -o BatchMode=yes
                -o UserKnownHostsFile=/dev/null
                -o StrictHostKeyChecking=no
